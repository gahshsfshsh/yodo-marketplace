generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

// ========== Пользователи ==========
model User {
  id            String         @id @default(cuid())
  email         String         @unique
  phone         String?        @unique
  passwordHash  String
  name          String
  avatar        String?
  role          UserRole       @default(CLIENT)
  isVerified    Boolean        @default(false)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  
  specialist    Specialist?
  orders        Order[]        @relation("ClientOrders")
  reviews       Review[]
  favorites     Favorite[]
  sentMessages  Message[]      @relation("SentMessages")
  notifications Notification[]
  jobs          Job[]
}

enum UserRole {
  CLIENT
  SPECIALIST
  ADMIN
}

// ========== Категории и Навыки ==========
model Category {
  id          String    @id @default(cuid())
  name        String    @unique
  slug        String    @unique
  description String?
  icon        String?
  image       String?
  order       Int       @default(0)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  
  skills      Skill[]
  services    Service[]
  jobs        Job[]
}

model Skill {
  id          String            @id @default(cuid())
  name        String
  slug        String            @unique
  categoryId  String
  createdAt   DateTime          @default(now())
  
  category    Category          @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  specialists SpecialistSkill[]
  
  @@index([categoryId])
}

// ========== Специалисты ==========
model Specialist {
  id              String            @id @default(cuid())
  userId          String            @unique
  title           String
  description     String            @db.Text
  city            String
  address         String?
  experience      Int               @default(0)
  rating          Float             @default(0)
  reviewCount     Int               @default(0)
  completedOrders Int               @default(0)
  responseTime    Int               @default(60)
  isVerified      Boolean           @default(false)
  isPremium       Boolean           @default(false)
  isAvailable     Boolean           @default(true)
  education       String?
  workSchedule    String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  skills          SpecialistSkill[]
  services        Service[]
  orders          Order[]
  reviews         Review[]
  portfolio       PortfolioItem[]
  certificates    Certificate[]
  favorites       Favorite[]
  
  @@index([city])
  @@index([rating])
  @@index([isVerified])
}

model SpecialistSkill {
  id           String     @id @default(cuid())
  specialistId String
  skillId      String
  level        SkillLevel @default(INTERMEDIATE)
  yearsExp     Int        @default(0)
  createdAt    DateTime   @default(now())
  
  specialist   Specialist @relation(fields: [specialistId], references: [id], onDelete: Cascade)
  skill        Skill      @relation(fields: [skillId], references: [id], onDelete: Cascade)
  
  @@unique([specialistId, skillId])
  @@index([specialistId])
  @@index([skillId])
}

enum SkillLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

// ========== Услуги ==========
model Service {
  id           String     @id @default(cuid())
  specialistId String
  categoryId   String
  name         String
  description  String?    @db.Text
  price        Float
  priceUnit    String     @default("за услугу")
  duration     Int?       // в минутах
  isActive     Boolean    @default(true)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  
  specialist   Specialist @relation(fields: [specialistId], references: [id], onDelete: Cascade)
  category     Category   @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  orders       Order[]
  
  @@index([specialistId])
  @@index([categoryId])
}

// ========== Портфолио и Сертификаты ==========
model PortfolioItem {
  id           String     @id @default(cuid())
  specialistId String
  title        String
  description  String?    @db.Text
  images       String[]
  tags         String[]
  completedAt  DateTime?
  createdAt    DateTime   @default(now())
  
  specialist   Specialist @relation(fields: [specialistId], references: [id], onDelete: Cascade)
  
  @@index([specialistId])
}

model Certificate {
  id           String     @id @default(cuid())
  specialistId String
  name         String
  issuer       String
  issueDate    DateTime
  expiryDate   DateTime?
  imageUrl     String?
  isVerified   Boolean    @default(false)
  createdAt    DateTime   @default(now())
  
  specialist   Specialist @relation(fields: [specialistId], references: [id], onDelete: Cascade)
  
  @@index([specialistId])
}

// ========== Заказы ==========
model Order {
  id              String        @id @default(cuid())
  clientId        String
  specialistId    String
  serviceId       String
  description     String?       @db.Text
  address         String?
  scheduledAt     DateTime?
  completedAt     DateTime?
  totalPrice      Float
  specialistPrice Float
  platformFee     Float
  status          OrderStatus   @default(PENDING)
  paymentStatus   PaymentStatus @default(PENDING)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  client          User          @relation("ClientOrders", fields: [clientId], references: [id], onDelete: Cascade)
  specialist      Specialist    @relation(fields: [specialistId], references: [id], onDelete: Cascade)
  service         Service       @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  review          Review?
  messages        Message[]
  transactions    Transaction[]
  
  @@index([clientId])
  @@index([specialistId])
  @@index([status])
}

enum OrderStatus {
  PENDING
  ACCEPTED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  DISPUTED
}

enum PaymentStatus {
  PENDING
  HELD
  RELEASED
  REFUNDED
}

// ========== Транзакции ==========
model Transaction {
  id            String            @id @default(cuid())
  orderId       String
  amount        Float
  type          TransactionType
  status        TransactionStatus @default(PENDING)
  paymentMethod String?
  externalId    String?
  description   String?
  createdAt     DateTime          @default(now())
  
  order         Order             @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  @@index([orderId])
}

enum TransactionType {
  PAYMENT
  PAYOUT
  REFUND
  FEE
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
}

// ========== Отзывы ==========
model Review {
  id           String     @id @default(cuid())
  orderId      String     @unique
  userId       String
  specialistId String
  rating       Int
  comment      String     @db.Text
  pros         String?
  cons         String?
  response     String?    @db.Text
  isPublished  Boolean    @default(true)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  
  order        Order      @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  specialist   Specialist @relation(fields: [specialistId], references: [id], onDelete: Cascade)
  
  @@index([specialistId])
  @@index([rating])
}

// ========== Избранное ==========
model Favorite {
  id           String     @id @default(cuid())
  userId       String
  specialistId String
  createdAt    DateTime   @default(now())
  
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  specialist   Specialist @relation(fields: [specialistId], references: [id], onDelete: Cascade)
  
  @@unique([userId, specialistId])
  @@index([userId])
}

// ========== Сообщения ==========
model Message {
  id        String   @id @default(cuid())
  orderId   String
  senderId  String
  content   String   @db.Text
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  sender    User     @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  
  @@index([orderId])
  @@index([senderId])
}

// ========== Уведомления ==========
model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String
  title     String
  message   String
  link      String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([isRead])
}

// ========== Вакансии/Задания ==========
model Job {
  id          String    @id @default(cuid())
  userId      String
  categoryId  String
  title       String
  description String    @db.Text
  budget      Float?
  budgetType  BudgetType @default(FIXED)
  city        String
  address     String?
  deadline    DateTime?
  status      JobStatus @default(OPEN)
  views       Int       @default(0)
  responses   Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  category    Category  @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([categoryId])
  @@index([status])
  @@index([city])
}

enum BudgetType {
  FIXED
  HOURLY
  NEGOTIABLE
}

enum JobStatus {
  OPEN
  IN_PROGRESS
  COMPLETED
  CLOSED
}




